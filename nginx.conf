#Elastic Beanstalk Nginx Configuration File

user                 nginx;
error_log            /var/log/nginx/error.log warn;
pid                  /var/run/nginx.pid;
worker_processes     auto;
worker_rlimit_nofile 65732;

events {
	worker_connections 1024;
}

http {
	include      /etc/nginx/mime.types;
	default_type application/octet-stream;

	log_format main '$remote_addr - $remote_user [$time_local] "$request" '
	                '$status $body_bytes_sent "$http_referer" '
	                '"$http_user_agent" "$http_x_forwarded_for"';

	include conf.d/*.conf;

	map $http_upgrade $connection_upgrade {
		default "upgrade";
	}

	server {
		listen     8000 default_server;
		access_log /var/log/nginx/access.log main;

		client_header_timeout 60;
		client_body_timeout   60;
		keepalive_timeout     60;
		gzip                  off;
		gzip_comp_level       4;
		gzip_types text/plain text/css application/json application/javascript
		           application/x-javascript text/xml application/xml
		           application/xml+rss text/javascript;

		# KIRBY CONFIG START
		client_max_body_size 32m;

		# Needed only locally to prevent nginx from timing out when using the
		# debugger, since the default timeout is only 60 seconds.
		fastcgi_read_timeout 86400;

		location ~ ^/(\.well-known|assets|media) {
			try_files $uri @kirby;
		}

		location / {
			# `/dev/null` is needed because `try_files` requires 2 parameters.
			# `try_files` is needed because `rewrite` does not allow passing to
			# named locations, such as `@kirby`.
			try_files /dev/null @kirby;
		}

		# Location block based on `/etc/nginx/conf.d/elasticbeanstalk/php.conf`.
		location @kirby {
			fastcgi_split_path_info ^(.+\.(?:php|phar))(/.*)$;

			fastcgi_intercept_errors on;
			fastcgi_index  index.php;

			fastcgi_param  QUERY_STRING       $query_string;
			fastcgi_param  REQUEST_METHOD     $request_method;
			fastcgi_param  CONTENT_TYPE       $content_type;
			fastcgi_param  CONTENT_LENGTH     $content_length;

			# `$fastcgi_script_name` is not used because it can be
			# `/some-page/index.php`, for example, rather than `index.php`.
			# Kirby expects everything to be directed to its main index.php.
			fastcgi_param  SCRIPT_NAME        /index.php;
			fastcgi_param  REQUEST_URI        $request_uri;
			fastcgi_param  DOCUMENT_URI       $document_uri;
			fastcgi_param  DOCUMENT_ROOT      $document_root;
			fastcgi_param  SERVER_PROTOCOL    $server_protocol;
			fastcgi_param  REQUEST_SCHEME     $scheme;
			fastcgi_param  HTTPS              $https if_not_empty;

			fastcgi_param  GATEWAY_INTERFACE  CGI/1.1;
			fastcgi_param  SERVER_SOFTWARE    nginx/$nginx_version;

			fastcgi_param  REMOTE_ADDR        $remote_addr;
			fastcgi_param  REMOTE_PORT        $remote_port;
			fastcgi_param  SERVER_ADDR        $server_addr;
			fastcgi_param  SERVER_PORT        $server_port;
			fastcgi_param  SERVER_NAME        $server_name;

			# PHP only, required if PHP was built with --enable-force-cgi-redirect
			fastcgi_param  REDIRECT_STATUS    200;

			fastcgi_param  SCRIPT_FILENAME  $document_root/index.php;
			fastcgi_param  PATH_INFO $fastcgi_path_info;
			fastcgi_pass   php:9000;
		}
		# KIRBY CONFIG END

		# DEFAULT BEANSTALK CONFIG START
		# Include the Elastic Beanstalk generated locations
		# include conf.d/elasticbeanstalk/*.conf;
		# DEFAULT BEANSTALK CONFIG END

		# CUSTOM BEANSTALK CONFIG START

		# Custom config is needed because `conf.d/elasticbeanstalk/*.conf`
		# includes the `/etc/nginx/conf.d/elasticbeanstalk/php.conf` file with
		# `location ~ \.(php|phar)(/.*)?$` which takes precedence over the named
		# @kirby location block. Those are the only lines needed from that file:
		root /var/www/html;
		index index.php index.html index.htm;

		# Still include the other Elastic Beanstalk file, because it's essential
		# for health reporting.
		# include conf.d/elasticbeanstalk/healthd.conf;

		# CUSTOM BEANSTALK CONFIG END
	}
}
